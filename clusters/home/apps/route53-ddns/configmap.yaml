apiVersion: v1
kind: ConfigMap
metadata:
  name: route53-ddns-script
  namespace: route53-ddns
data:
  update-route53.sh: |
    #!/bin/bash
    set -e

    echo "$(date): Starting Route53 DDNS update"

    # Get current public IP
    PUBLIC_IP=$(curl -s https://api.ipify.org)
    echo "Current public IP: $PUBLIC_IP"

    # Validate IP address
    if [[ ! $PUBLIC_IP =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
      echo "ERROR: Failed to get valid public IP address"
      exit 1
    fi

    # Get current DNS record
    # Try with trailing dot first (Route53 format)
    CURRENT_RECORD=$(aws route53 list-resource-record-sets \
      --hosted-zone-id "$HOSTED_ZONE_ID" \
      --query "ResourceRecordSets[?Name=='${RECORD_NAME}.']" \
      --output json)

    # If no record found, try without trailing dot
    if [ "$(echo "$CURRENT_RECORD" | jq -r 'length')" = "0" ]; then
      echo "No record found with trailing dot, trying without..."
      CURRENT_RECORD=$(aws route53 list-resource-record-sets \
        --hosted-zone-id "$HOSTED_ZONE_ID" \
        --query "ResourceRecordSets[?Name=='${RECORD_NAME}']" \
        --output json)
    fi

    CURRENT_IP=$(echo "$CURRENT_RECORD" | jq -r '.[0].ResourceRecords[0].Value // "none"')
    echo "Current DNS IP: $CURRENT_IP"
    echo "DNS Record found: $(echo "$CURRENT_RECORD" | jq -r '.[0].Name // "none"')"
    
    # Debug: Show what we're querying
    echo "Querying for record: ${RECORD_NAME}."

    # Check if update is needed
    if [ "$PUBLIC_IP" = "$CURRENT_IP" ]; then
      echo "IP address has not changed. No update needed."
      exit 0
    fi

    echo "IP address has changed from $CURRENT_IP to $PUBLIC_IP. Updating Route53..."

    # Create change batch JSON
    CHANGE_BATCH=$(cat <<EOF
    {
      "Changes": [{
        "Action": "UPSERT",
        "ResourceRecordSet": {
          "Name": "$RECORD_NAME",
          "Type": "A",
          "TTL": $RECORD_TTL,
          "ResourceRecords": [{"Value": "$PUBLIC_IP"}]
        }
      }]
    }
    EOF
    )

    # Update Route53
    CHANGE_ID=$(aws route53 change-resource-record-sets \
      --hosted-zone-id "$HOSTED_ZONE_ID" \
      --change-batch "$CHANGE_BATCH" \
      --query 'ChangeInfo.Id' \
      --output text)

    echo "Route53 update submitted: $CHANGE_ID"
    echo "âœ… Successfully updated $RECORD_NAME to $PUBLIC_IP"
